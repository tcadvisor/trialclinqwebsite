const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./aiScoring-DFmdv_JO.js","./ctgov-0NYeoFZ-.js","./geocode-C0RmwoTY.js"])))=>i.map(i=>d[i]);
import{_ as at}from"./index-BDmcj3uD.js";import"./trials-DUAD2qh_.js";import{a as $,f as yt}from"./ctgov-0NYeoFZ-.js";import{a as ct,g as bt}from"./geocode-C0RmwoTY.js";function J(e,o=0,n=100){return Math.max(o,Math.min(n,e))}function St(){let e=0,o=0,n=0,i=0,s=0;try{const t=localStorage.getItem("auth:v1");if(t){const r=JSON.parse(t),u=(r==null?void 0:r.user)??{};u!=null&&u.email&&(e+=7),u!=null&&u.firstName&&(e+=7),u!=null&&u.lastName&&(e+=6)}}catch{}try{const t=localStorage.getItem("tc_consent");if(t){const r=JSON.parse(t),m=[r.section1,r.section2,r.section3,r.section4,r.final].reduce((v,l)=>v+(l?1:0),0);o=J(m*4,0,20)}}catch{}try{const t=localStorage.getItem("tc_docs");if(t){const r=JSON.parse(t),u=Array.isArray(r)?r.length:0;n=J(Math.min(u,4)*5,0,20)}}catch{}try{const t=JSON.parse(localStorage.getItem("tc_notify_email")||"true"),r=JSON.parse(localStorage.getItem("tc_notify_trials")||"true");i=(t?3:0)+(r?2:0)}catch{}try{const t=localStorage.getItem("tc_health_profile_v1");if(t){const r=JSON.parse(t),u=[r.weight,r.gender,r.phone,r.age,r.race,r.language,r.bloodGroup,r.genotype,r.primaryCondition,r.diagnosed,Array.isArray(r.allergies)&&r.allergies.length>0?"ok":"",Array.isArray(r.medications)&&r.medications.length>0?"ok":"",r.ecog,r.diseaseStage,r.biomarkers,Array.isArray(r.priorTherapies)&&r.priorTherapies.length>0?"ok":""],v=u.reduce((l,b)=>l+(b&&String(b).trim()!==""?1:0),0)/u.length;s=J(Math.round(v*35),0,35)}}catch{}const c={basics:e,consent:o,documents:n,notifications:i,healthProfile:s};return{percent:J(Math.round(e+o+n+i+s)),breakdown:c}}const wt="tc_health_profile_v1",U="tc_eligibility_profile";function It(){try{const e=localStorage.getItem(U);if(!e)return null;const n=JSON.parse(e).dob||"";if(!n)return null;const i=new Date(n);if(isNaN(i.getTime()))return null;const s=new Date;let c=s.getFullYear()-i.getFullYear();const f=s.getMonth()-i.getMonth();return(f<0||f===0&&s.getDate()<i.getDate())&&c--,c}catch{return null}}function W(){try{const e=localStorage.getItem(U);if(!e)return{loc:""};const o=JSON.parse(e),n=String(o.loc||"").trim(),i=String(o.radius||"").trim()||void 0;return{loc:n,radius:i}}catch{return{loc:""}}}function Mt(){let e=null,o=null,n=null,i=[],s=[],c=null;try{const f=localStorage.getItem(wt);if(f){const t=JSON.parse(f),r=Number(t==null?void 0:t.age);e=Number.isFinite(r)?r:null,o=(t!=null&&t.gender?String(t.gender):"").trim()||null,n=(t!=null&&t.primaryCondition?String(t.primaryCondition):"").trim()||null,Array.isArray(t==null?void 0:t.medications)&&(i=t.medications.map(l=>String((l==null?void 0:l.name)||"").toLowerCase()).filter(Boolean)),Array.isArray(t==null?void 0:t.allergies)&&(s=t.allergies.map(l=>String((l==null?void 0:l.name)||"").toLowerCase()).filter(Boolean));const u=(t!=null&&t.additionalInfo?String(t.additionalInfo):"").trim(),m=[];if(t!=null&&t.ecog&&m.push(`ECOG: ${t.ecog}`),t!=null&&t.diseaseStage&&m.push(`Stage/Subtype: ${t.diseaseStage}`),t!=null&&t.biomarkers&&m.push(`Biomarkers: ${t.biomarkers}`),Array.isArray(t==null?void 0:t.priorTherapies)&&t.priorTherapies.length){const l=t.priorTherapies.map(b=>[b==null?void 0:b.name,b==null?void 0:b.date].filter(Boolean).join(" ")).filter(Boolean).join("; ");l&&m.push(`Prior tx: ${l}`)}if(t!=null&&t.comorbidityCardiac||t!=null&&t.comorbidityRenal||t!=null&&t.comorbidityHepatic||t!=null&&t.comorbidityAutoimmune){const l=[t.comorbidityCardiac&&"cardiac",t.comorbidityRenal&&"renal",t.comorbidityHepatic&&"hepatic",t.comorbidityAutoimmune&&"autoimmune"].filter(Boolean).join(", ");l&&m.push(`Comorbidities: ${l}`)}if(t!=null&&t.infectionHIV||t!=null&&t.infectionHBV||t!=null&&t.infectionHCV){const l=[t.infectionHIV&&"HIV",t.infectionHBV&&"HBV",t.infectionHCV&&"HCV"].filter(Boolean).join(", ");l&&m.push(`Infections: ${l}`)}c=[u,m.join(`
`)].filter(Boolean).join(`
`)||null}}catch{}if(e==null&&(e=It(),e==null))try{const f=localStorage.getItem(U);if(f){const t=JSON.parse(f),r=Number(t.age);Number.isFinite(r)&&(e=r)}}catch{}return{age:e,gender:o,primaryCondition:n,medications:i,allergies:s,additionalInfo:c}}const vt=new Set(["the","a","an","and","or","of","for","to","in","on","with","without","by","at","from","about","into","over","after","before","is","are","be","being","been","this","that","these","those","study","trial","clinical","investigating","investigation","impact","patients","patient","therapy","treatment"]);function C(e){return e?e.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(o=>o&&!vt.has(o)):[]}function Nt(e,o){if(!o.length)return!0;const n=e.toLowerCase();return o.every(i=>n.includes(i))}function Tt(e,o){const n=C(o);return n.length?e.filter(i=>{var t,r,u,m;const s=(((r=(t=i.protocolSection)==null?void 0:t.identificationModule)==null?void 0:r.briefTitle)||"").toString(),c=(((m=(u=i.protocolSection)==null?void 0:u.conditionsModule)==null?void 0:m.conditions)||[]).join(" "),f=`${s} ${c}`;return Nt(f,n)}):e}function lt(e,o){if(e.length===0||o.length===0)return 0;const n=new Set(o);let i=0;for(const s of e)n.has(s)&&i++;return i}function Y(e,o=0,n=100){return Math.max(o,Math.min(n,e))}function Ct(e){var s,c;const o=((c=(s=e.protocolSection)==null?void 0:s.designModule)==null?void 0:c.phases)||[];if(!o||o.length===0)return"";const n=String(o[0]);if(/PHASE\s*1\/2/i.test(n)||/1\/2/.test(n))return"Phase I/II";if(/PHASE\s*2\/3/i.test(n)||/2\/3/.test(n))return"Phase II/III";const i=n.match(/\d+/);return i?`Phase ${i[0]}`:n}function _t(e){var i,s;const o=(((s=(i=e.protocolSection)==null?void 0:i.statusModule)==null?void 0:s.overallStatus)||"").toString(),n=o.toUpperCase();return n==="RECRUITING"?"Recruiting":n==="ENROLLING_BY_INVITATION"?"Enrolling by invitation":o||""}function z(e){var n,i,s;const o=(s=(i=(n=e.protocolSection)==null?void 0:n.contactsLocationsModule)==null?void 0:i.locations)==null?void 0:s[0];return o?[o.city,o.state].filter(Boolean).join(", "):""}function ut(e){if(!e)return;const o=String(e).match(/([0-9]+)(mi|km)?/i);if(!o)return;const n=Number(o[1]);return Number.isFinite(n)?(o[2]||"mi").toLowerCase()==="km"?Math.round(n*.621371):n:void 0}function kt(e,o,n,i){const s=m=>m*Math.PI/180,f=s(n-e),t=s(i-o),r=Math.sin(f/2)**2+Math.cos(s(e))*Math.cos(s(n))*Math.sin(t/2)**2;return 3958.8*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}function ft(e){return(e||[]).flatMap(o=>C(o))}function xt(e,o){var B,P,N,T,G,g;const n=((P=(B=e.protocolSection)==null?void 0:B.identificationModule)==null?void 0:P.briefTitle)||"",i=C(n),s=((T=(N=e.protocolSection)==null?void 0:N.conditionsModule)==null?void 0:T.conditions)||[],c=ft(s),f=C(o.primaryCondition||""),t=C(o.additionalInfo||""),r=new Set(i.concat(c)),u=[];for(const F of f.concat(t))r.has(F)&&u.length<4&&u.push(F);const m=((g=(G=e.protocolSection)==null?void 0:G.statusModule)==null?void 0:g.overallStatus)||"",v=z(e),l=W(),b=[];m&&b.push(/recruit/i.test(m)?"Recruiting":m),u.length&&b.push(`Matched on: ${u.join(", ")}`),v&&b.push(`Site: ${v}`),l.loc&&b.push(`Near: ${l.loc}`),l.radius&&b.push(`Within ${l.radius}`);const A=b.join(" · ");return A.length>160?A.slice(0,157)+"...":A}function Rt(e,o){var M,_,V,q,O,H;const n=((_=(M=e.protocolSection)==null?void 0:M.identificationModule)==null?void 0:_.briefTitle)||"",i=C(n),s=((q=(V=e.protocolSection)==null?void 0:V.conditionsModule)==null?void 0:q.conditions)||[],c=ft(s),f=C(o.primaryCondition||""),t=C(o.additionalInfo||""),r=lt(i.concat(c),f.concat(t)),u=Math.max(1,f.length+t.length),m=Y(r/u*100,0,100),v=Math.round(.6*m),l=((H=(O=e.protocolSection)==null?void 0:O.statusModule)==null?void 0:H.overallStatus)||"",b=/recruit/i.test(l)?25:10,A=C(z(e)),B=C(o.additionalInfo||""),P=W(),N=C(P.loc||""),T=lt(A,B.concat(N)),G=Y(T*5,0,15),{breakdown:g}=St(),F=Math.round(g.healthProfile/35*10);return Y(b+v+At(o,e)+G+F,0,100)}function At(e,o){var c,f;const n=typeof e.age=="number"?e.age:null;if(n==null)return 0;const i=(((f=(c=o.protocolSection)==null?void 0:c.identificationModule)==null?void 0:f.briefTitle)||"").toString(),s=mt(i);return!s||s.min!=null&&n<s.min||s.max!=null&&(s.maxExclusive?n>=s.max:n>s.max)?0:5}function mt(e){const o=(e||"").toLowerCase();let n=o.match(/(\d{1,3})\s*(?:to|–|-|—)\s*(?:less\s+than\s*)?(\d{1,3})\s*(?:years?|yrs?|yo)\b/);if(n){const i=Number(n[1]),s=Number(n[2]),c=/less\s+than\s*\d{1,3}\s*(?:years?|yrs?|yo)\b/.test(o.slice(n.index||0,(n.index||0)+n[0].length));return{min:Number.isFinite(i)?i:void 0,max:Number.isFinite(s)?s:void 0,maxExclusive:c}}if(n=o.match(/(\d{1,3})\s*(?:years?|yrs?|yo)\s*(?:and\s*older|and\s*over|or\s*older)\b/),n){const i=Number(n[1]);return{min:Number.isFinite(i)?i:void 0}}if(n=o.match(/(?:under|less\s*than)\s*(\d{1,3})\s*(?:years?|yrs?|yo)\b/),n){const i=Number(n[1]);return{max:Number.isFinite(i)?i:void 0,maxExclusive:!0}}return/\b(pediatric|child|children|infant|adolescent)s?\b/.test(o)?{max:17,maxExclusive:!1}:/\bolder\s+adult|elderly|senior\b/.test(o)?{min:65}:/\badult(s)?\b/.test(o)&&!/\b(child|children|pediatric)\b/.test(o)?{min:18}:null}function E(e,o){const n=(e||"").toLowerCase();return o.some(i=>n.includes(i.toLowerCase()))}function Lt(e,o,n){var r,u;const i=(e.additionalInfo||"").toLowerCase(),s=(e.medications||[]).map(m=>String(m).toLowerCase()),c=`${(((u=(r=o.protocolSection)==null?void 0:r.identificationModule)==null?void 0:u.briefTitle)||"").toLowerCase()}
${(n||"").toLowerCase()}`;if(/(planned|schedule[rd])\s+(elective\s+)?(hepato|hepatobiliary|hepato[-\s]?pancreato[-\s]?biliary|pancreatic|colorectal)/.test(c)&&!E(i,["planned surgery","elective surgery","hepato","hepatobiliary","pancreat","colorectal","colectomy","whipple","hepatectomy"]))return{ok:!1,reason:"No qualifying elective HPB/colorectal surgery planned"};const t=["sildenafil","tadalafil","vardenafil","avanafil","pde5"];return E(c,["pde5","phosphodiesterase"])&&s.some(m=>t.some(v=>m.includes(v)))?{ok:!1,reason:"Daily PDE5 inhibitor"}:E(c,["tamsulosin therapy as a home medication","on tamsulosin at baseline","tamsulosin at baseline"])&&s.some(m=>m.includes("tamsulosin")||m.includes("flomax"))?{ok:!1,reason:"On tamsulosin at baseline"}:E(c,["genitourinary","gu procedure","urology procedure","prostate","bladder","ureter","kidney"])&&E(i,["prostate surgery","cystectomy","bladder surgery","ureter","nephrectomy","urology procedure"])?{ok:!1,reason:"GU procedure planned"}:E(c,["same day foley removal","remove foley on day of surgery","pod0"])&&E(i,["same day foley","pod0 foley removal","immediate catheter removal"])?{ok:!1,reason:"Same-day Foley removal planned"}:E(c,["ng tube retention","nasogastric tube retention","pod1"])&&E(i,["ng tube planned","nasogastric tube retention"])?{ok:!1,reason:"NG tube retention planned"}:{ok:!0}}function Et(e){const o=(e||"").toLowerCase();return/(female|women|woman)\s*-?\s*only\b/.test(o)||/\bfemales?\s+only\b/.test(o)?"female":/(male|men|man)\s*-?\s*only\b/.test(o)||/\bmales?\s+only\b/.test(o)?"male":/women\sof\schild-bearing\s*potential|pregnan/i.test(o)?"female":null}function dt(e,o,n){var t,r;if(e==null||!Number.isFinite(e))return!0;const s=`${(((r=(t=o.protocolSection)==null?void 0:t.identificationModule)==null?void 0:r.briefTitle)||"").toString()}
${n||""}`,c=mt(s);if(!c)return!0;const f=e;return!(c.min!=null&&f<c.min||c.max!=null&&(c.maxExclusive?f>=c.max:f>c.max))}function Pt(e,o,n){var t,r;const i=(e||"").toLowerCase();if(!i)return!0;const c=`${(((r=(t=o.protocolSection)==null?void 0:t.identificationModule)==null?void 0:r.briefTitle)||"").toString()}
${n||""}`,f=Et(c);return f?!(f==="female"&&!i.startsWith("fem")||f==="male"&&!i.startsWith("male")):!0}async function $t(e=50){var H,K,Q,X,Z,tt,et,ot,nt,it,rt,st;const o="__tc_cached_matches_v1",n=globalThis[o];if((H=n==null?void 0:n.data)!=null&&H.length)return n.data.slice(0,e);const i=Mt(),s=(i.primaryCondition||"").trim(),f=C(i.additionalInfo||"").slice(0,3).join(" "),t=s||f||"",r=Math.max(10,Math.min(100,e)),u=["RECRUITING","ENROLLING_BY_INVITATION"],{loc:m,radius:v}=W();let l={};try{l=await ct()||{}}catch{l={}}const b=(l==null?void 0:l.label)||m,A=ut(v),B=typeof A=="number"&&Number.isFinite(A),P=typeof l.lat=="number"&&typeof l.lng=="number",N=B&&P;if(B&&!P){const a=[];return a.__noResultsWithinRadius=!0,a}const T=async(a,d={withGeo:!0,withStatuses:!0})=>{const p={q:a,pageSize:r};if(d.withGeo&&P)if(p.loc=b,N){const y=`${A}mi`,S={...p,lat:l.lat,lng:l.lng,radius:y};return d.withStatuses?(await Promise.all(u.map(h=>$({...S,status:h})))).flatMap(h=>h.studies||[]):(await $(S)).studies||[]}else{const y={...p,lat:l.lat,lng:l.lng};return d.withStatuses?(await Promise.all(u.map(k=>$({...y,status:k})))).flatMap(k=>k.studies||[]):(await $(y)).studies||[]}return p.loc=b,d.withStatuses?(await Promise.all(u.map(S=>$({...p,status:S})))).flatMap(S=>S.studies||[]):(await $(p)).studies||[]},G=!!b&&!!t;let g=G?await T("",{withGeo:!0,withStatuses:!0}):await T(t,{withGeo:!0,withStatuses:!0});G&&g&&g.length>0&&(g=Tt(g,t)),G||((!g||g.length===0)&&(N||(g=await T(t,{withGeo:!0,withStatuses:!1}))),(!g||g.length===0)&&(N||(g=await T(t,{withGeo:!1,withStatuses:!0}))),(!g||g.length===0)&&t&&t!==s&&(g=await T(s||"",{withGeo:!0,withStatuses:!0})),(!g||g.length===0)&&(N||(g=await T(t,{withGeo:!1,withStatuses:!1}))),(!g||g.length===0)&&(N||(g=await T("",{withGeo:!0,withStatuses:!0})))),g||(g=[]);const F=new Set,M=[];for(const a of g){const d=((Q=(K=a.protocolSection)==null?void 0:K.identificationModule)==null?void 0:Q.nctId)||"";if(!d||F.has(d))continue;const p=(((Z=(X=a.protocolSection)==null?void 0:X.statusModule)==null?void 0:Z.overallStatus)||"").toString().toUpperCase();if(p!=="RECRUITING"&&p!=="ENROLLING_BY_INVITATION"||!dt(i.age,a))continue;F.add(d);const y=((et=(tt=a.protocolSection)==null?void 0:tt.identificationModule)==null?void 0:et.briefTitle)||d,S=_t(a),x=Ct(a),k=((it=(nt=(ot=a.protocolSection)==null?void 0:ot.sponsorCollaboratorsModule)==null?void 0:nt.leadSponsor)==null?void 0:it.name)||"",h=z(a);let w=Rt(a,i);const I=((st=(rt=a.protocolSection)==null?void 0:rt.conditionsModule)==null?void 0:st.conditions)||[],L=xt(a,i);try{const{getCachedAiScore:D}=await at(async()=>{const{getCachedAiScore:j}=await import("./aiScoring-DFmdv_JO.js");return{getCachedAiScore:j}},__vite__mapDeps([0,1,2]),import.meta.url),R=D(d,i);R&&typeof R.score=="number"&&(w=R.score)}catch{}M.push({slug:d.toLowerCase(),nctId:d,title:y,status:S,phase:x,aiScore:w,interventions:I.slice(0,3),center:k,location:h,reason:L})}let _,V=!1;try{const a=await ct(),d=typeof a.lat=="number"?a.lat:void 0,p=typeof a.lng=="number"?a.lng:void 0,y=ut(a.radius);if(_=y,d!=null&&p!=null){const S=Array.from(new Set(M.map(h=>(h.location||"").trim()).filter(Boolean))),x=new Map,k=await Promise.all(S.map(async h=>{try{const w=await bt(h);return[h,w]}catch{return[h,null]}}));for(const[h,w]of k){const I=w&&typeof w.lat=="number"?w.lat:void 0,L=w&&typeof w.lng=="number"?w.lng:void 0;I!=null&&L!=null&&x.set(h,{lat:I,lng:L})}for(const h of M){const w=(h.location||"").trim(),I=w?x.get(w):void 0;if(I){const L=kt(d,p,I.lat,I.lng);h.distanceMi=Math.round(L),h.inRadius=typeof y=="number"?L<=y:void 0}}}}catch{}if(N&&typeof _=="number"){const a=M.filter(d=>typeof d.distanceMi!="number"?!0:d.distanceMi<=_);V=a.length===0,M.length=0,M.push(...a)}else if(typeof _=="number"){const a=M.filter(d=>typeof d.distanceMi!="number"||d.distanceMi<=_);a.length>0&&(M.length=0,M.push(...a))}M.__noResultsWithinRadius=V;async function q(a,d){var x,k;const p=a.slice(0,Math.min(d,a.length)),y=[];for(let h=0;h<p.length;h+=10)y.push(p.slice(h,h+10));const S=new Set;for(const h of y){const w=await Promise.all(h.map(async I=>{try{return await yt(I.nctId)}catch{return{studies:[]}}}));for(let I=0;I<h.length;I++){const L=h[I],D=w[I],R=D.studies&&D.studies[0],j=(k=(x=R==null?void 0:R.protocolSection)==null?void 0:x.eligibilityModule)==null?void 0:k.eligibilityCriteria,ht=dt(i.age,R||{},j),gt=Pt(i.gender,R||{},j),pt=Lt(i,R||{},j);(!ht||!gt||!pt.ok)&&S.add(L.nctId)}}return a.filter(h=>!S.has(h.nctId))}const O=await q(M,40);for(const a of O)if(typeof a.distanceMi=="number"){const d=a.distanceMi;let p=0;if(typeof _=="number"&&Number.isFinite(_)){const y=_;d<=y?p=25*(1-d/y):p=-15*Math.min(2,(d-y)/y)}else p=20*(1-Math.min(500,d)/500);a.aiScore=Y(Math.round((a.aiScore??0)+p),0,100)}O.sort((a,d)=>{const p=(d.aiScore??0)-(a.aiScore??0);if(p!==0)return p;const y=typeof a.distanceMi=="number"?a.distanceMi:Number.POSITIVE_INFINITY,S=typeof d.distanceMi=="number"?d.distanceMi:Number.POSITIVE_INFINITY;return y-S});try{const{scoreTopKWithAI:a}=await at(async()=>{const{scoreTopKWithAI:p}=await import("./aiScoring-DFmdv_JO.js");return{scoreTopKWithAI:p}},__vite__mapDeps([0,1,2]),import.meta.url),d=await a(O,15,i);return globalThis[o]={data:d,ts:Date.now()},d.slice(0,e)}catch{return globalThis[o]={data:O,ts:Date.now()},O.slice(0,e)}}export{Rt as a,St as c,$t as g,Mt as r};
