import{f as k,R as r,u as M,j as e,L as $,i as W}from"./index-DLD9h1BK.js";import{g as U}from"./matching-BM0Ac_FF.js";import{e as F}from"./trialInterests-GnY5KQLx.js";import{P as q}from"./PatientHeader-D7OzikkY.js";import"./trials-DUAD2qh_.js";import"./ctgov-D30T4kGK.js";import"./geocode-Cez6o5Pc.js";import"./HeaderActions-VMSc5EzH.js";function V(){const{user:n}=k(),[m,w]=r.useState(""),[c,v]=r.useState([]),[I,h]=r.useState(!1),[S,R]=r.useState(""),[C,y]=r.useState(!1),[b,f]=r.useState(null),[p,E]=r.useState(new Set),[u,j]=r.useState(new Set),i=M();r.useMemo(()=>{const s=new URLSearchParams(i.search),t=Number(s.get("offset"));return Number.isFinite(t)&&t>0?Math.floor(t):0},[i.search]),r.useEffect(()=>{let s=!1;const t=async()=>{try{y(!0),f(null);const o=await U(100);s||v(o)}catch(o){s||f(o instanceof Error?o.message:"Failed to load matches")}finally{s||y(!1)}};t();const a=()=>t();return window.addEventListener("storage",a),window.addEventListener("visibilitychange",a),window.addEventListener("focus",a),()=>{s=!0,window.removeEventListener("storage",a),window.removeEventListener("visibilitychange",a),window.removeEventListener("focus",a)}},[]);const d=r.useMemo(()=>{const s=m.trim().toLowerCase();return s?c.filter(t=>[t.title,t.nctId,t.phase,t.status,t.location,t.center,...t.interventions].join(" ").toLowerCase().includes(s)):c},[m,c]),L=async s=>{if(!(n!=null&&n.userId)){alert("Please log in to express interest");return}j(t=>new Set(t).add(s.nctId));try{const t=W({email:n.email,firstName:n.firstName,lastName:n.lastName,userId:n.userId,role:"patient"}),a=await F(s.nctId,s.title,t,n.userId);a.ok?(E(o=>new Set(o).add(s.nctId)),alert("Interest expressed successfully! Researchers will be able to see your interest in this trial.")):alert(a.message||"Failed to express interest")}catch(t){console.error("Error expressing interest:",t),alert("Failed to express interest")}finally{j(t=>{const a=new Set(t);return a.delete(s.nctId),a})}},x=25,l=r.useMemo(()=>{const s=new URLSearchParams(i.search),t=Number(s.get("page"));return Number.isFinite(t)&&t>0?Math.floor(t):1},[i.search]),g=Math.max(1,Math.ceil(d.length/x)),P=r.useMemo(()=>d.slice((l-1)*x,l*x),[d,l,x]),N=(s,t)=>e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium whitespace-nowrap ${t==="green"?"bg-green-100 text-green-700":"bg-violet-100 text-violet-700"}`,children:s}),T=c.__noResultsWithinRadius===!0;return e.jsxs("div",{className:"min-h-screen bg-gray-50 text-gray-900",children:[e.jsx(q,{}),e.jsxs("main",{className:"max-w-6xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-semibold",children:"Eligible Trials"}),e.jsx("div",{className:"relative",children:e.jsx("input",{className:"w-64 rounded-full border px-4 py-2 text-sm focus:outline-none",placeholder:"Search",value:m,onChange:s=>w(s.target.value)})})]}),C&&e.jsx("div",{className:"mb-4 rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-800",children:"Refreshing matches…"}),b&&e.jsx("div",{className:"mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:b}),T&&c.length===0&&e.jsx("div",{className:"mb-6 rounded-lg border border-amber-200 bg-amber-50 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-xl",children:"⚠️"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-amber-900",children:"No trials found within your search radius"}),e.jsx("p",{className:"mt-1 text-sm text-amber-800",children:"We couldn't find any matching trials within your specified distance. Consider:"}),e.jsxs("ul",{className:"mt-2 list-inside list-disc space-y-1 text-sm text-amber-800",children:[e.jsx("li",{children:"Increasing your travel distance in your health profile"}),e.jsx("li",{children:"Checking your location is correctly set"}),e.jsx("li",{children:"Expanding your search to explore options further away"})]}),e.jsx("button",{onClick:()=>window.location.href="/patients/health-profile",className:"mt-3 inline-flex items-center gap-2 rounded-lg bg-amber-900 px-4 py-2 text-sm text-white hover:bg-amber-800",children:"Update Location Preferences →"})]})]})}),e.jsxs("div",{className:"overflow-hidden rounded-xl border bg-white",children:[e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-left text-gray-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 font-medium",children:"Trial Title"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Trial ID"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Trial Status"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Trial Phase"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Compatibility Score"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Interventions"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Actions"})]})}),e.jsxs("tbody",{children:[P.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx($,{to:`/study/${s.nctId}`,state:{score:s.aiScore,rationale:s.aiRationale||s.reason},className:"text-gray-900 hover:underline",children:s.title})}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:s.nctId}),e.jsx("td",{className:"px-4 py-3",children:N(s.status==="Now Recruiting"?"Recruiting":s.status,"green")}),e.jsx("td",{className:"px-4 py-3",children:N(s.phase,"violet")}),e.jsxs("td",{className:"px-4 py-3 align-top",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{children:[s.aiScore,"%"]}),(s.aiRationale||s.reason)&&e.jsx("button",{type:"button",onClick:()=>{R(`${s.title}

${s.aiRationale||s.reason}`),h(!0)},className:"ml-2 inline-flex items-center rounded-full border px-2 py-0.5 text-xs text-gray-600 hover:bg-gray-50","aria-label":"Why this match",children:"Why"})]}),(s.aiRationale||s.reason)&&e.jsx("div",{className:"mt-1 text-xs text-gray-500 line-clamp-2",children:s.aiRationale||s.reason})]}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:s.interventions.join(" / ")}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>L(s),disabled:u.has(s.nctId)||p.has(s.nctId),className:`inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium transition ${p.has(s.nctId)?"bg-green-100 text-green-700 border border-green-300":u.has(s.nctId)?"border bg-gray-100 text-gray-600":"border hover:bg-blue-50 text-blue-600 hover:text-blue-700"}`,title:"Express your interest in this trial so researchers can see that you're interested",children:u.has(s.nctId)?"Expressing...":p.has(s.nctId)?"✓ Interested":"Express Interest"}),e.jsx("a",{href:`https://clinicaltrials.gov/study/${encodeURIComponent(s.nctId)}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 rounded-lg border px-3 py-1.5 text-xs hover:bg-gray-50",children:"View →"})]})})]},s.slug)),d.length===0&&e.jsx("tr",{children:e.jsxs("td",{colSpan:7,className:"px-4 py-6 text-center text-gray-500",children:["No trials to show. Add your primary condition and location in your ",e.jsx("a",{href:"/patients/health-profile",className:"underline",children:"Health Profile"})," to get matches."]})})]})]}),e.jsxs("div",{className:"border-t px-4 py-3 flex items-center justify-between text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"rounded-lg border px-3 py-1.5 hover:bg-gray-50 disabled:opacity-50",onClick:()=>{const s=Math.max(1,l-1),t=new URLSearchParams(i.search);t.set("page",String(s)),window.history.replaceState({},"",`${i.pathname}?${t.toString()}`)},disabled:l<=1,children:"Previous"}),e.jsx("button",{className:"rounded-lg border px-3 py-1.5 hover:bg-gray-50 disabled:opacity-50",onClick:()=>{const s=Math.min(g,l+1),t=new URLSearchParams(i.search);t.set("page",String(s)),window.history.replaceState({},"",`${i.pathname}?${t.toString()}`)},disabled:l>=g,children:"Next"})]}),e.jsxs("div",{children:["Page ",l," of ",g," · ",d.length," matches"]})]})]})]}),I&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>h(!1)}),e.jsxs("div",{className:"relative z-10 w-full max-w-md rounded-xl border bg-white p-4 shadow-lg",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Why this trial matches you"}),e.jsx("button",{className:"rounded-md p-1 text-gray-500 hover:bg-gray-100",onClick:()=>h(!1),"aria-label":"Close",children:"✕"})]}),e.jsx("div",{className:"mt-3 whitespace-pre-wrap text-sm text-gray-700",children:S})]})]}),e.jsx("footer",{className:"w-full border-t mt-16",children:e.jsxs("div",{className:"w-full max-w-[1200px] mx-auto px-4 py-6 text-sm text-gray-600 flex items-center justify-between",children:[e.jsx("span",{children:"Copyright © 2025 TrialCliniq."}),e.jsx("span",{children:"Terms · Privacy"})]})})]})}export{V as default};
