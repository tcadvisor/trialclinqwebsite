import{f as j,s as L}from"./ctgov-0NYeoFZ-.js";import{r as D}from"./geocode-C0RmwoTY.js";const f={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1},k="tc_ai_scores_v4";function p(t,e=0,i=100){return Math.max(e,Math.min(i,t))}function R(t){try{const e=t.trim().replace(/^```\w*\n|```$/g,"").trim();return JSON.parse(e)}catch{return null}}function P(t){let e=5381;for(let i=0;i<t.length;i++)e=e*33^t.charCodeAt(i);return(e>>>0).toString(16)}function J(){try{const t=localStorage.getItem(k);return t?JSON.parse(t):{}}catch{return{}}}function x(t){try{localStorage.setItem(k,JSON.stringify(t))}catch{}}function B(t){const e=JSON.stringify({age:t.age??null,gender:(t.gender||"").toLowerCase(),primaryCondition:(t.primaryCondition||"").toLowerCase(),meds:(t.medications||[]).map(i=>String(i)).sort(),allergies:(t.allergies||[]).map(i=>String(i)).sort(),info:(t.additionalInfo||"").toLowerCase()});return P(e)}function G(t,e){try{const i=JSON.stringify({age:e.age??null,gender:(e.gender||"").toLowerCase(),primaryCondition:(e.primaryCondition||"").toLowerCase(),meds:(e.medications||[]).map(o=>String(o)).sort(),allergies:(e.allergies||[]).map(o=>String(o)).sort(),info:(e.additionalInfo||"").toLowerCase()}),l=`${P(i)}|${t}`,n=J()[l];return n&&Number.isFinite(n.score)?{score:p(Math.round(n.score)),rationale:n.rationale}:null}catch{return null}}function U(t){const e=[];typeof t.age=="number"&&e.push(`Age: ${t.age}`),t.gender&&e.push(`Gender: ${t.gender}`),t.primaryCondition&&e.push(`Primary condition: ${t.primaryCondition}`),t.medications&&t.medications.length&&e.push(`Current medications: ${t.medications.join(", ")}`),t.allergies&&t.allergies.length&&e.push(`Allergies: ${t.allergies.join(", ")}`),t.additionalInfo&&e.push(`Additional info: ${t.additionalInfo}`);const i=D();return i.loc&&e.push(`Home location: ${i.loc}`),i.radius&&e.push(`Travel radius: ${i.radius}`),e.join(`
`)}function F(t){var h,d,m,g,S,w,y,I,b,N,C,O,T,$,E,A,M;const e=((d=(h=t.protocolSection)==null?void 0:h.identificationModule)==null?void 0:d.nctId)||"",i=((g=(m=t.protocolSection)==null?void 0:m.identificationModule)==null?void 0:g.briefTitle)||"",s=((w=(S=t.protocolSection)==null?void 0:S.statusModule)==null?void 0:w.overallStatus)||"",l=((I=(y=t.protocolSection)==null?void 0:y.conditionsModule)==null?void 0:I.conditions)||[],r=((N=(b=t.protocolSection)==null?void 0:b.designModule)==null?void 0:N.phases)||[],n=(T=(O=(C=t.protocolSection)==null?void 0:C.contactsLocationsModule)==null?void 0:O.locations)==null?void 0:T[0],o=[n==null?void 0:n.city,n==null?void 0:n.state,n==null?void 0:n.country].filter(Boolean).join(", "),a=((E=($=t==null?void 0:t.protocolSection)==null?void 0:$.descriptionModule)==null?void 0:E.briefSummary)||"",c=((M=(A=t==null?void 0:t.protocolSection)==null?void 0:A.eligibilityModule)==null?void 0:M.eligibilityCriteria)||"",u=String(c).slice(0,1200);return[`NCT: ${e}`,`Title: ${i}`,`Status: ${s}`,`Conditions: ${l.join("; ")}`,`Phases: ${r.join(", ")}`,`Location: ${o}`,a?`Summary: ${a}`:"",u?`Eligibility Criteria: ${u}`:""].filter(Boolean).join(`
`)}function V(){const t=f==null?void 0:f.VITE_AI_SCORER_URL,e=f==null?void 0:f.VITE_OPENAI_API_KEY;return typeof window<"u"?!!t:!!(t||e)}async function Y(t,e,i){const s="tc_ai_webhook_status_v1";try{const n=localStorage.getItem(s);if(n)try{const o=JSON.parse(n),a=Date.now()-(o.ts||0);if(!o.ok&&a<1e3*60*10)return null}catch{}}catch{}const l=async()=>{try{const n=await L(t,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e),signal:i});if(!n||!n.ok){try{localStorage.setItem(s,JSON.stringify({ok:!1,ts:Date.now()}))}catch{}return null}const o=await n.json().catch(()=>null);if(!o){try{localStorage.setItem(s,JSON.stringify({ok:!1,ts:Date.now()}))}catch{}return null}try{localStorage.setItem(s,JSON.stringify({ok:!0,ts:Date.now()}))}catch{}const a=typeof o.score=="number"?p(Math.round(o.score)):Number(o.score);return Number.isFinite(a)?{score:p(Math.round(a)),rationale:String(o.rationale||o.reason||"")}:null}catch{try{localStorage.setItem(s,JSON.stringify({ok:!1,ts:Date.now()}))}catch{}return null}},r=await l();return r||(await new Promise(n=>setTimeout(n,500)),l())}async function K(t,e){var s,l,r;if(typeof window<"u")return null;const i=f==null?void 0:f.VITE_OPENAI_API_KEY;if(!i)return null;try{const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${i}`},body:JSON.stringify({model:"gpt-4o",temperature:.1,messages:[{role:"system",content:"You score clinical trial eligibility and fit. Output ONLY valid compact JSON with fields score (0-100 integer) and rationale (<=160 chars). Do not include any other text."},{role:"user",content:t}],response_format:{type:"json_object"}}),signal:e});if(!n.ok)return null;const o=await n.json(),a=(r=(l=(s=o==null?void 0:o.choices)==null?void 0:s[0])==null?void 0:l.message)==null?void 0:r.content;if(!a)return null;const c=R(a);return!c||!Number.isFinite(c.score)?null:{score:p(Math.round(c.score)),rationale:c.rationale}}catch{return null}}async function z(t,e,i){try{const l=`${B(e)}|${t}`,r=J(),n=r[l];if(n&&Date.now()-n.ts<1e3*60*60*24*7)return{score:n.score,rationale:n.rationale};if(!V())return null;const o=await j(t,i),a=o&&o.studies&&o.studies[0];if(!a)return null;const c=U(e),u=F(a),h=`Patient Profile
${c}

Trial
${u}

Scoring guidance:
- Base score from inclusion/exclusion likelihood and condition match
- If patient's AGE is outside the trial's eligibility range (as stated in title/criteria), score 0-5 and mention age mismatch
- If gender is restricted and does not match, score 0-10
- If criteria require a planned elective procedure (e.g., hepato-pancreato-biliary or colorectal surgery) and profile lacks that signal, score 0-15 with rationale mentioning missing planned surgery
- Penalize exclusions like daily PDE5 inhibitors or baseline tamsulosin if present in profile meds
- Strongly penalize if outside Travel radius; strongly reward if inside
- Reward status Recruiting; weigh phase modestly
- Return an integer 0-100 with meaningful variance across trials

Strictly output JSON: {"score": 0-100 integer, "rationale": "<=160 chars"}.`,d=new AbortController,m=setTimeout(()=>d.abort(),2e4);let g=null;const y=(f==null?void 0:f.VITE_AI_SCORER_URL)||"/.netlify/functions/ai-scorer";return g=await Y(y,{profile:e,nctId:t,study:a,prompt:h},d.signal),g||(g=await K(h,d.signal)),g?(clearTimeout(m),g&&(r[l]={score:g.score,rationale:g.rationale,ts:Date.now()},x(r)),g):(clearTimeout(m),null)}catch{return null}}async function H(t,e,i){const s=t.slice(0,Math.min(e,t.length));(async()=>{try{const r=[...s],n=new Array(r.length);async function o(c){for(let u=c;u<r.length;u+=3){const h=r[u];try{const d=await z(h.nctId,i);d&&(n[u]={idx:u,score:d.score,rationale:d.rationale})}catch{}}}await Promise.all([o(0),o(1),o(2)]);let a=!1;for(let c=0;c<n.length;c++){const u=n[c];u&&typeof u.score=="number"&&(a=!0)}if(a)try{window.dispatchEvent(new Event("storage"))}catch{}}catch{}})();const l=t.map(r=>({...r}));return l.sort((r,n)=>{const o=(n.aiScore??0)-(r.aiScore??0);if(o!==0)return o;const a=typeof r.distanceMi=="number"?r.distanceMi:Number.POSITIVE_INFINITY,c=typeof n.distanceMi=="number"?n.distanceMi:Number.POSITIVE_INFINITY;return a-c}),l}export{G as getCachedAiScore,z as scoreStudyWithAI,H as scoreTopKWithAI};
