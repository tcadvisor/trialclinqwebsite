import{r as w,q as N,e as T,j as t}from"./index-3kZk0rNx.js";import{S as D}from"./SiteHeader-CHrr19_Y.js";import"./HeaderActions-BUfyNln2.js";function O(){const[P,x]=w.useState("loading"),[B,b]=w.useState(""),[k]=N(),S=T();return w.useEffect(()=>{(async()=>{try{console.log("[EPIC CALLBACK] Starting OAuth callback handler...");const c=k.get("code"),C=k.get("error"),f=k.get("error_description");if(console.log("[EPIC CALLBACK] URL Parameters:",{code:c?`${c.substring(0,20)}...`:"NOT FOUND",error:C||"none",errorDescription:f||"none"}),C){const e=`EPIC Authorization failed: ${C}${f?` - ${f}`:""}`;console.error(`[EPIC CALLBACK] ${e}`),b(e),x("error");return}if(!c){const e="No authorization code received from EPIC. This typically means: 1) User denied authorization, 2) Redirect URI doesn't match EPIC settings, or 3) OAuth configuration is incorrect.";console.error(`[EPIC CALLBACK] ${e}`),b(e),x("error");return}console.log("[EPIC CALLBACK] Step 1: Authorization code received successfully");const m=localStorage.getItem("epic_code_verifier"),K=localStorage.getItem("epic_state");if(console.log("[EPIC CALLBACK] Step 2: Checking local storage:",{hasCodeVerifier:!!m,verifierLength:(m==null?void 0:m.length)||0,hasState:!!K}),!m){const e="Missing code verifier in local storage. Local storage may have been cleared, or the initial EPIC connection did not complete properly. Please try the connection again.";console.error(`[EPIC CALLBACK] ${e}`),console.log("[EPIC CALLBACK] localStorage contents:",Object.keys(localStorage)),b(e),x("error");return}console.log("[EPIC CALLBACK] Step 3: Exchanging authorization code for token...");let s;try{const e={code:c,code_verifier:m};console.log("[EPIC CALLBACK] Sending token exchange request to /.netlify/functions/epic-token-exchange"),s=await fetch("/.netlify/functions/epic-token-exchange",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),console.log("[EPIC CALLBACK] Step 4: Token exchange response received:",{status:s.status,statusText:s.statusText,headers:{contentType:s.headers.get("content-type"),contentLength:s.headers.get("content-length")}})}catch(e){console.error("[EPIC CALLBACK] Step 4: Failed to reach token exchange function:",e);const r=e instanceof Error?e.message:String(e);throw new Error(`Could not connect to token exchange server (/.netlify/functions/epic-token-exchange). Error: ${r}. This means the Netlify serverless function is not deployed or accessible.`)}if(!s.ok){console.log("[EPIC CALLBACK] Step 5: Token exchange returned error status");let e=`Token exchange failed with status ${s.status} ${s.statusText}`;try{const r=s.headers.get("content-type");if(console.log("[EPIC CALLBACK] Error response content-type:",r),r&&r.includes("application/json")){const d=await s.json();console.log("[EPIC CALLBACK] Error data:",d),e=d.message||d.error||e}else{const d=await s.text();console.error("[EPIC CALLBACK] Error response text:",d.substring(0,300)),e=d?`Server returned: ${d.substring(0,150)}`:e}}catch(r){console.error("[EPIC CALLBACK] Failed to parse error response:",r)}throw new Error(e)}console.log("[EPIC CALLBACK] Step 5: Token exchange successful, parsing response...");let n;try{const e=s.headers.get("content-type");if(console.log("[EPIC CALLBACK] Success response content-type:",e),e&&e.includes("application/json"))n=await s.json();else{const r=await s.text();throw console.error("[EPIC CALLBACK] Unexpected response type, got text:",r.substring(0,200)),new Error(`Expected JSON response, got content-type: ${e}`)}console.log("[EPIC CALLBACK] Step 6: Token data parsed successfully:",{hasAccessToken:!!n.access_token,hasPatient:!!n.patient,hasRefreshToken:!!n.refresh_token,patientId:n.patient})}catch(e){throw console.error("[EPIC CALLBACK] Failed to parse token exchange response:",e),new Error(`Failed to parse server response: ${e instanceof Error?e.message:String(e)}`)}if(console.log("[EPIC CALLBACK] Step 7: Saving tokens to localStorage..."),localStorage.setItem("epic:tokens:v1",JSON.stringify({access_token:n.access_token,token_type:n.token_type,expires_in:n.expires_in,refresh_token:n.refresh_token,patient:n.patient})),localStorage.removeItem("epic_code_verifier"),localStorage.removeItem("epic_state"),console.log("[EPIC CALLBACK] Cleaned up temporary PKCE values from localStorage"),n.patientData){console.log("[EPIC CALLBACK] Step 8: Saving patient data to localStorage...");const e=n.patientData,r=new Date().toISOString(),d=new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}),h={};if(e.name&&(h.name={value:e.name,source:"epic",syncedAt:r}),e.gender){const i={male:"Male",female:"Female",other:"Non-binary"}[e.gender.toLowerCase()]||e.gender;h.gender={value:i,source:"epic",syncedAt:r}}if(e.birthDate){const a=new Date(e.birthDate),i=new Date;let o=i.getFullYear()-a.getFullYear();const l=i.getMonth()-a.getMonth();(l<0||l===0&&i.getDate()<a.getDate())&&o--,h.age={value:String(o),source:"epic",syncedAt:r}}if(e.medications&&Array.isArray(e.medications.entry)){const a=e.medications.entry.map(i=>{var l,g,p,u,y,A,L,E,I,v,j;const o=i.resource||{};return{name:((l=o.medicationCodeableConcept)==null?void 0:l.text)||((g=o.medicationReference)==null?void 0:g.display)||"Unknown Medication",dose:(L=(A=(y=(u=(p=o.dosageInstruction)==null?void 0:p[0])==null?void 0:u.doseAndRate)==null?void 0:y[0])==null?void 0:A.doseQuantity)!=null&&L.value?`${o.dosageInstruction[0].doseAndRate[0].doseQuantity.value} ${o.dosageInstruction[0].doseAndRate[0].doseQuantity.unit||""}`:void 0,schedule:(j=(v=(I=(E=o.dosageInstruction)==null?void 0:E[0])==null?void 0:I.timing)==null?void 0:v.repeat)!=null&&j.frequency?`${o.dosageInstruction[0].timing.repeat.frequency}x daily`:void 0}});a.length>0&&(h.medications={value:a,source:"epic",syncedAt:r})}if(e.allergies&&Array.isArray(e.allergies.entry)){const a=e.allergies.entry.map(i=>{var l,g,p,u,y,A,L,E,I,v;const o=i.resource||{};return{name:((l=o.code)==null?void 0:l.text)||((u=(p=(g=o.code)==null?void 0:g.coding)==null?void 0:p[0])==null?void 0:u.display)||"Unknown Allergy",reaction:((E=(L=(A=(y=o.reaction)==null?void 0:y[0])==null?void 0:A.manifestation)==null?void 0:L[0])==null?void 0:E.text)||void 0,severity:((v=(I=o.reaction)==null?void 0:I[0])==null?void 0:v.severity)||void 0}});a.length>0&&(h.allergies={value:a,source:"epic",syncedAt:r})}if(e.conditions&&Array.isArray(e.conditions.entry)){const a=e.conditions.entry.map(i=>{var l,g,p,u;const o=i.resource||{};return((l=o.code)==null?void 0:l.text)||((u=(p=(g=o.code)==null?void 0:g.coding)==null?void 0:p[0])==null?void 0:u.display)||"Unknown Condition"});if(a.length>0){const i=a[0];h.primaryCondition={value:i,source:"epic",syncedAt:r}}}localStorage.setItem("epic:patient:v1",JSON.stringify({patientId:n.patient,patientData:n.patientData,profileData:h,syncedAt:r,syncedAtDisplay:d})),console.log("[EPIC CALLBACK] EPIC patient data saved with profile autofill data")}console.log("[EPIC CALLBACK] SUCCESS: All tokens and data saved. Authorization complete!"),x("success"),window.opener?(console.log("[EPIC CALLBACK] Closing popup window (opened from popup)"),setTimeout(()=>{window.close()},1500)):(console.log("[EPIC CALLBACK] Redirecting to health profile (direct navigation)"),setTimeout(()=>{S("/patients/health-profile",{state:{epicConnected:!0,patientData:n.patientData}})},2e3))}catch(c){const C=c instanceof Error?c.message:"Unknown error occurred",f=`OAuth Callback Error:

${C}

For debugging, check the browser console (F12 â†’ Console) for detailed step-by-step logs marked with [EPIC CALLBACK].`;console.error("[EPIC CALLBACK] FATAL ERROR:",c),console.error("[EPIC CALLBACK] Full error context:",{errorMessage:C,errorType:c instanceof Error?c.constructor.name:typeof c,timestamp:new Date().toISOString()}),b(f),x("error")}})()},[k,S]),t.jsxs("div",{className:"min-h-screen bg-white text-gray-900",children:[t.jsx(D,{}),t.jsxs("main",{className:"max-w-2xl mx-auto px-4 py-16",children:[P==="loading"&&t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"inline-block",children:t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-blue-200 border-t-blue-600"})}),t.jsx("h1",{className:"mt-6 text-2xl font-semibold",children:"Connecting to EPIC..."}),t.jsx("p",{className:"mt-2 text-gray-600",children:"Retrieving your health information securely."})]}),P==="success"&&t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"inline-block w-12 h-12 bg-green-100 rounded-full flex items-center justify-center",children:t.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsx("h1",{className:"mt-6 text-2xl font-semibold",children:"Connected Successfully!"}),t.jsx("p",{className:"mt-2 text-gray-600",children:"Your EPIC health data has been imported. Redirecting..."})]}),P==="error"&&t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"inline-block w-12 h-12 bg-red-100 rounded-full flex items-center justify-center",children:t.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"mt-6 text-2xl font-semibold",children:"Connection Failed"}),t.jsx("div",{className:"mt-4 text-left bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-lg mx-auto",children:t.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap font-mono",children:B})}),t.jsxs("div",{className:"mt-4 text-left bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-lg mx-auto",children:[t.jsx("p",{className:"text-xs text-blue-900 font-semibold mb-2",children:"ðŸ’¡ Troubleshooting Tips:"}),t.jsxs("ul",{className:"text-xs text-blue-800 space-y-1 list-disc list-inside",children:[t.jsx("li",{children:"Open Developer Tools (F12) and go to the Console tab"}),t.jsx("li",{children:"Look for logs starting with [EPIC] or [EPIC CALLBACK]"}),t.jsx("li",{children:'Check the "Network" tab to see the actual HTTP requests and responses'}),t.jsx("li",{children:"Verify your redirect URI matches what's configured in the EPIC developer portal"}),t.jsx("li",{children:"Ensure environment variables are set: VITE_EPIC_CLIENT_ID, VITE_EPIC_REDIRECT_URI, VITE_EPIC_FHIR_URL"})]})]}),t.jsx("button",{onClick:()=>S("/patients/ehr"),className:"mt-6 inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Go Back"})]})]})]})}export{O as default};
