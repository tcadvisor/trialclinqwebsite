const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./aiScoring-DFmdv_JO.js","./ctgov-0NYeoFZ-.js","./geocode-C0RmwoTY.js"])))=>i.map(i=>d[i]);
import{_ as it}from"./index-znp1ZwVH.js";import"./trials-DUAD2qh_.js";import{a as B,f as ht}from"./ctgov-0NYeoFZ-.js";import{a as rt,g as gt}from"./geocode-C0RmwoTY.js";function Y(o,e=0,n=100){return Math.max(e,Math.min(n,o))}function pt(){let o=0,e=0,n=0,i=0,s=0;try{const t=localStorage.getItem("auth:v1");if(t){const r=JSON.parse(t),u=(r==null?void 0:r.user)??{};u!=null&&u.email&&(o+=7),u!=null&&u.firstName&&(o+=7),u!=null&&u.lastName&&(o+=6)}}catch{}try{const t=localStorage.getItem("tc_consent");if(t){const r=JSON.parse(t),l=[r.section1,r.section2,r.section3,r.section4,r.final].reduce((M,m)=>M+(m?1:0),0);e=Y(l*4,0,20)}}catch{}try{const t=localStorage.getItem("tc_docs");if(t){const r=JSON.parse(t),u=Array.isArray(r)?r.length:0;n=Y(Math.min(u,4)*5,0,20)}}catch{}try{const t=JSON.parse(localStorage.getItem("tc_notify_email")||"true"),r=JSON.parse(localStorage.getItem("tc_notify_trials")||"true");i=(t?3:0)+(r?2:0)}catch{}try{const t=localStorage.getItem("tc_health_profile_v1");if(t){const r=JSON.parse(t),u=[r.weight,r.gender,r.phone,r.age,r.race,r.language,r.bloodGroup,r.genotype,r.primaryCondition,r.diagnosed,Array.isArray(r.allergies)&&r.allergies.length>0?"ok":"",Array.isArray(r.medications)&&r.medications.length>0?"ok":"",r.ecog,r.diseaseStage,r.biomarkers,Array.isArray(r.priorTherapies)&&r.priorTherapies.length>0?"ok":""],M=u.reduce((m,b)=>m+(b&&String(b).trim()!==""?1:0),0)/u.length;s=Y(Math.round(M*35),0,35)}}catch{}const a={basics:o,consent:e,documents:n,notifications:i,healthProfile:s};return{percent:Y(Math.round(o+e+n+i+s)),breakdown:a}}const yt="tc_health_profile_v1",U="tc_eligibility_profile";function bt(){try{const o=localStorage.getItem(U);if(!o)return null;const n=JSON.parse(o).dob||"";if(!n)return null;const i=new Date(n);if(isNaN(i.getTime()))return null;const s=new Date;let a=s.getFullYear()-i.getFullYear();const f=s.getMonth()-i.getMonth();return(f<0||f===0&&s.getDate()<i.getDate())&&a--,a}catch{return null}}function W(){try{const o=localStorage.getItem(U);if(!o)return{loc:""};const e=JSON.parse(o),n=String(e.loc||"").trim(),i=String(e.radius||"").trim()||void 0;return{loc:n,radius:i}}catch{return{loc:""}}}function St(){let o=null,e=null,n=null,i=[],s=[],a=null;try{const f=localStorage.getItem(yt);if(f){const t=JSON.parse(f),r=Number(t==null?void 0:t.age);o=Number.isFinite(r)?r:null,e=(t!=null&&t.gender?String(t.gender):"").trim()||null,n=(t!=null&&t.primaryCondition?String(t.primaryCondition):"").trim()||null,Array.isArray(t==null?void 0:t.medications)&&(i=t.medications.map(m=>String((m==null?void 0:m.name)||"").toLowerCase()).filter(Boolean)),Array.isArray(t==null?void 0:t.allergies)&&(s=t.allergies.map(m=>String((m==null?void 0:m.name)||"").toLowerCase()).filter(Boolean));const u=(t!=null&&t.additionalInfo?String(t.additionalInfo):"").trim(),l=[];if(t!=null&&t.ecog&&l.push(`ECOG: ${t.ecog}`),t!=null&&t.diseaseStage&&l.push(`Stage/Subtype: ${t.diseaseStage}`),t!=null&&t.biomarkers&&l.push(`Biomarkers: ${t.biomarkers}`),Array.isArray(t==null?void 0:t.priorTherapies)&&t.priorTherapies.length){const m=t.priorTherapies.map(b=>[b==null?void 0:b.name,b==null?void 0:b.date].filter(Boolean).join(" ")).filter(Boolean).join("; ");m&&l.push(`Prior tx: ${m}`)}if(t!=null&&t.comorbidityCardiac||t!=null&&t.comorbidityRenal||t!=null&&t.comorbidityHepatic||t!=null&&t.comorbidityAutoimmune){const m=[t.comorbidityCardiac&&"cardiac",t.comorbidityRenal&&"renal",t.comorbidityHepatic&&"hepatic",t.comorbidityAutoimmune&&"autoimmune"].filter(Boolean).join(", ");m&&l.push(`Comorbidities: ${m}`)}if(t!=null&&t.infectionHIV||t!=null&&t.infectionHBV||t!=null&&t.infectionHCV){const m=[t.infectionHIV&&"HIV",t.infectionHBV&&"HBV",t.infectionHCV&&"HCV"].filter(Boolean).join(", ");m&&l.push(`Infections: ${m}`)}a=[u,l.join(`
`)].filter(Boolean).join(`
`)||null}}catch{}if(o==null&&(o=bt(),o==null))try{const f=localStorage.getItem(U);if(f){const t=JSON.parse(f),r=Number(t.age);Number.isFinite(r)&&(o=r)}}catch{}return{age:o,gender:e,primaryCondition:n,medications:i,allergies:s,additionalInfo:a}}const wt=new Set(["the","a","an","and","or","of","for","to","in","on","with","without","by","at","from","about","into","over","after","before","is","are","be","being","been","this","that","these","those","study","trial","clinical","investigating","investigation","impact","patients","patient","therapy","treatment"]);function k(o){return o?o.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(e=>e&&!wt.has(e)):[]}function It(o,e){if(!e.length)return!0;const n=o.toLowerCase();return e.every(i=>n.includes(i))}function Mt(o,e){const n=k(e);return n.length?o.filter(i=>{var t,r,u,l;const s=(((r=(t=i.protocolSection)==null?void 0:t.identificationModule)==null?void 0:r.briefTitle)||"").toString(),a=(((l=(u=i.protocolSection)==null?void 0:u.conditionsModule)==null?void 0:l.conditions)||[]).join(" "),f=`${s} ${a}`;return It(f,n)}):o}function st(o,e){if(o.length===0||e.length===0)return 0;const n=new Set(e);let i=0;for(const s of o)n.has(s)&&i++;return i}function D(o,e=0,n=100){return Math.max(e,Math.min(n,o))}function vt(o){var s,a;const e=((a=(s=o.protocolSection)==null?void 0:s.designModule)==null?void 0:a.phases)||[];if(!e||e.length===0)return"";const n=String(e[0]);if(/PHASE\s*1\/2/i.test(n)||/1\/2/.test(n))return"Phase I/II";if(/PHASE\s*2\/3/i.test(n)||/2\/3/.test(n))return"Phase II/III";const i=n.match(/\d+/);return i?`Phase ${i[0]}`:n}function Nt(o){var i,s;const e=(((s=(i=o.protocolSection)==null?void 0:i.statusModule)==null?void 0:s.overallStatus)||"").toString(),n=e.toUpperCase();return n==="RECRUITING"?"Recruiting":n==="ENROLLING_BY_INVITATION"?"Enrolling by invitation":e||""}function z(o){var n,i,s;const e=(s=(i=(n=o.protocolSection)==null?void 0:n.contactsLocationsModule)==null?void 0:i.locations)==null?void 0:s[0];return e?[e.city,e.state].filter(Boolean).join(", "):""}function at(o){if(!o)return;const e=String(o).match(/([0-9]+)(mi|km)?/i);if(!e)return;const n=Number(e[1]);return Number.isFinite(n)?(e[2]||"mi").toLowerCase()==="km"?Math.round(n*.621371):n:void 0}function Tt(o,e,n,i){const s=l=>l*Math.PI/180,f=s(n-o),t=s(i-e),r=Math.sin(f/2)**2+Math.cos(s(o))*Math.cos(s(n))*Math.sin(t/2)**2;return 3958.8*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}function lt(o){return(o||[]).flatMap(e=>k(e))}function Ct(o,e){var T,C,P,g,G,w;const n=((C=(T=o.protocolSection)==null?void 0:T.identificationModule)==null?void 0:C.briefTitle)||"",i=k(n),s=((g=(P=o.protocolSection)==null?void 0:P.conditionsModule)==null?void 0:g.conditions)||[],a=lt(s),f=k(e.primaryCondition||""),t=k(e.additionalInfo||""),r=new Set(i.concat(a)),u=[];for(const N of f.concat(t))r.has(N)&&u.length<4&&u.push(N);const l=((w=(G=o.protocolSection)==null?void 0:G.statusModule)==null?void 0:w.overallStatus)||"",M=z(o),m=W(),b=[];l&&b.push(/recruit/i.test(l)?"Recruiting":l),u.length&&b.push(`Matched on: ${u.join(", ")}`),M&&b.push(`Site: ${M}`),m.loc&&b.push(`Near: ${m.loc}`),m.radius&&b.push(`Within ${m.radius}`);const A=b.join(" · ");return A.length>160?A.slice(0,157)+"...":A}function kt(o,e){var F,q,O,$,V,H;const n=((q=(F=o.protocolSection)==null?void 0:F.identificationModule)==null?void 0:q.briefTitle)||"",i=k(n),s=(($=(O=o.protocolSection)==null?void 0:O.conditionsModule)==null?void 0:$.conditions)||[],a=lt(s),f=k(e.primaryCondition||""),t=k(e.additionalInfo||""),r=st(i.concat(a),f.concat(t)),u=Math.max(1,f.length+t.length),l=D(r/u*100,0,100),M=Math.round(.6*l),m=((H=(V=o.protocolSection)==null?void 0:V.statusModule)==null?void 0:H.overallStatus)||"",b=/recruit/i.test(m)?25:10,A=k(z(o)),T=k(e.additionalInfo||""),C=W(),P=k(C.loc||""),g=st(A,T.concat(P)),G=D(g*5,0,15),{breakdown:w}=pt(),N=Math.round(w.healthProfile/35*10);return D(b+M+xt(e,o)+G+N,0,100)}function xt(o,e){var a,f;const n=typeof o.age=="number"?o.age:null;if(n==null)return 0;const i=(((f=(a=e.protocolSection)==null?void 0:a.identificationModule)==null?void 0:f.briefTitle)||"").toString(),s=ut(i);return!s||s.min!=null&&n<s.min||s.max!=null&&(s.maxExclusive?n>=s.max:n>s.max)?0:5}function ut(o){const e=(o||"").toLowerCase();let n=e.match(/(\d{1,3})\s*(?:to|–|-|—)\s*(?:less\s+than\s*)?(\d{1,3})\s*(?:years?|yrs?|yo)\b/);if(n){const i=Number(n[1]),s=Number(n[2]),a=/less\s+than\s*\d{1,3}\s*(?:years?|yrs?|yo)\b/.test(e.slice(n.index||0,(n.index||0)+n[0].length));return{min:Number.isFinite(i)?i:void 0,max:Number.isFinite(s)?s:void 0,maxExclusive:a}}if(n=e.match(/(\d{1,3})\s*(?:years?|yrs?|yo)\s*(?:and\s*older|and\s*over|or\s*older)\b/),n){const i=Number(n[1]);return{min:Number.isFinite(i)?i:void 0}}if(n=e.match(/(?:under|less\s*than)\s*(\d{1,3})\s*(?:years?|yrs?|yo)\b/),n){const i=Number(n[1]);return{max:Number.isFinite(i)?i:void 0,maxExclusive:!0}}return/\b(pediatric|child|children|infant|adolescent)s?\b/.test(e)?{max:17,maxExclusive:!1}:/\bolder\s+adult|elderly|senior\b/.test(e)?{min:65}:/\badult(s)?\b/.test(e)&&!/\b(child|children|pediatric)\b/.test(e)?{min:18}:null}function E(o,e){const n=(o||"").toLowerCase();return e.some(i=>n.includes(i.toLowerCase()))}function _t(o,e,n){var r,u;const i=(o.additionalInfo||"").toLowerCase(),s=(o.medications||[]).map(l=>String(l).toLowerCase()),a=`${(((u=(r=e.protocolSection)==null?void 0:r.identificationModule)==null?void 0:u.briefTitle)||"").toLowerCase()}
${(n||"").toLowerCase()}`;if(/(planned|schedule[rd])\s+(elective\s+)?(hepato|hepatobiliary|hepato[-\s]?pancreato[-\s]?biliary|pancreatic|colorectal)/.test(a)&&!E(i,["planned surgery","elective surgery","hepato","hepatobiliary","pancreat","colorectal","colectomy","whipple","hepatectomy"]))return{ok:!1,reason:"No qualifying elective HPB/colorectal surgery planned"};const t=["sildenafil","tadalafil","vardenafil","avanafil","pde5"];return E(a,["pde5","phosphodiesterase"])&&s.some(l=>t.some(M=>l.includes(M)))?{ok:!1,reason:"Daily PDE5 inhibitor"}:E(a,["tamsulosin therapy as a home medication","on tamsulosin at baseline","tamsulosin at baseline"])&&s.some(l=>l.includes("tamsulosin")||l.includes("flomax"))?{ok:!1,reason:"On tamsulosin at baseline"}:E(a,["genitourinary","gu procedure","urology procedure","prostate","bladder","ureter","kidney"])&&E(i,["prostate surgery","cystectomy","bladder surgery","ureter","nephrectomy","urology procedure"])?{ok:!1,reason:"GU procedure planned"}:E(a,["same day foley removal","remove foley on day of surgery","pod0"])&&E(i,["same day foley","pod0 foley removal","immediate catheter removal"])?{ok:!1,reason:"Same-day Foley removal planned"}:E(a,["ng tube retention","nasogastric tube retention","pod1"])&&E(i,["ng tube planned","nasogastric tube retention"])?{ok:!1,reason:"NG tube retention planned"}:{ok:!0}}function Rt(o){const e=(o||"").toLowerCase();return/(female|women|woman)\s*-?\s*only\b/.test(e)||/\bfemales?\s+only\b/.test(e)?"female":/(male|men|man)\s*-?\s*only\b/.test(e)||/\bmales?\s+only\b/.test(e)?"male":/women\sof\schild-bearing\s*potential|pregnan/i.test(e)?"female":null}function ct(o,e,n){var t,r;if(o==null||!Number.isFinite(o))return!0;const s=`${(((r=(t=e.protocolSection)==null?void 0:t.identificationModule)==null?void 0:r.briefTitle)||"").toString()}
${n||""}`,a=ut(s);if(!a)return!0;const f=o;return!(a.min!=null&&f<a.min||a.max!=null&&(a.maxExclusive?f>=a.max:f>a.max))}function At(o,e,n){var t,r;const i=(o||"").toLowerCase();if(!i)return!0;const a=`${(((r=(t=e.protocolSection)==null?void 0:t.identificationModule)==null?void 0:r.briefTitle)||"").toString()}
${n||""}`,f=Rt(a);return f?!(f==="female"&&!i.startsWith("fem")||f==="male"&&!i.startsWith("male")):!0}async function Ot(o=50){var $,V,H,K,Q,X,Z,tt,et,ot,nt;const e=St(),n=(e.primaryCondition||"").trim(),s=k(e.additionalInfo||"").slice(0,3).join(" "),a=n||s||"",f=Math.max(10,Math.min(100,o)),t=["RECRUITING","ENROLLING_BY_INVITATION"],{loc:r,radius:u}=W();let l={};try{l=await rt()||{}}catch{l={}}const M=(l==null?void 0:l.label)||r,m=at(u),b=typeof m=="number"&&Number.isFinite(m),A=typeof l.lat=="number"&&typeof l.lng=="number",T=b&&A;if(b&&!A){const c=[];return c.__noResultsWithinRadius=!0,c}const C=async(c,d={withGeo:!0,withStatuses:!0})=>{const p={q:c,pageSize:f};if(d.withGeo&&A)if(p.loc=M,T){const y=`${m}mi`,S={...p,lat:l.lat,lng:l.lng,radius:y};return d.withStatuses?(await Promise.all(t.map(h=>B({...S,status:h})))).flatMap(h=>h.studies||[]):(await B(S)).studies||[]}else{const y={...p,lat:l.lat,lng:l.lng};return d.withStatuses?(await Promise.all(t.map(x=>B({...y,status:x})))).flatMap(x=>x.studies||[]):(await B(y)).studies||[]}return p.loc=M,d.withStatuses?(await Promise.all(t.map(S=>B({...p,status:S})))).flatMap(S=>S.studies||[]):(await B(p)).studies||[]},P=!!M&&!!a;let g=P?await C("",{withGeo:!0,withStatuses:!0}):await C(a,{withGeo:!0,withStatuses:!0});P&&g&&g.length>0&&(g=Mt(g,a)),P||((!g||g.length===0)&&(T||(g=await C(a,{withGeo:!0,withStatuses:!1}))),(!g||g.length===0)&&(T||(g=await C(a,{withGeo:!1,withStatuses:!0}))),(!g||g.length===0)&&a&&a!==n&&(g=await C(n||"",{withGeo:!0,withStatuses:!0})),(!g||g.length===0)&&(T||(g=await C(a,{withGeo:!1,withStatuses:!1}))),(!g||g.length===0)&&(T||(g=await C("",{withGeo:!0,withStatuses:!0})))),g||(g=[]);const G=new Set,w=[];for(const c of g){const d=((V=($=c.protocolSection)==null?void 0:$.identificationModule)==null?void 0:V.nctId)||"";if(!d||G.has(d))continue;const p=(((K=(H=c.protocolSection)==null?void 0:H.statusModule)==null?void 0:K.overallStatus)||"").toString().toUpperCase();if(p!=="RECRUITING"&&p!=="ENROLLING_BY_INVITATION"||!ct(e.age,c))continue;G.add(d);const y=((X=(Q=c.protocolSection)==null?void 0:Q.identificationModule)==null?void 0:X.briefTitle)||d,S=Nt(c),_=vt(c),x=((et=(tt=(Z=c.protocolSection)==null?void 0:Z.sponsorCollaboratorsModule)==null?void 0:tt.leadSponsor)==null?void 0:et.name)||"",h=z(c);let I=kt(c,e);const v=((nt=(ot=c.protocolSection)==null?void 0:ot.conditionsModule)==null?void 0:nt.conditions)||[],L=Ct(c,e);try{const{getCachedAiScore:J}=await it(async()=>{const{getCachedAiScore:j}=await import("./aiScoring-DFmdv_JO.js");return{getCachedAiScore:j}},__vite__mapDeps([0,1,2]),import.meta.url),R=J(d,e);R&&typeof R.score=="number"&&(I=R.score)}catch{}w.push({slug:d.toLowerCase(),nctId:d,title:y,status:S,phase:_,aiScore:I,interventions:v.slice(0,3),center:x,location:h,reason:L})}let N,F=!1;try{const c=await rt(),d=typeof c.lat=="number"?c.lat:void 0,p=typeof c.lng=="number"?c.lng:void 0,y=at(c.radius);if(N=y,d!=null&&p!=null){const S=Array.from(new Set(w.map(h=>(h.location||"").trim()).filter(Boolean))),_=new Map,x=await Promise.all(S.map(async h=>{try{const I=await gt(h);return[h,I]}catch{return[h,null]}}));for(const[h,I]of x){const v=I&&typeof I.lat=="number"?I.lat:void 0,L=I&&typeof I.lng=="number"?I.lng:void 0;v!=null&&L!=null&&_.set(h,{lat:v,lng:L})}for(const h of w){const I=(h.location||"").trim(),v=I?_.get(I):void 0;if(v){const L=Tt(d,p,v.lat,v.lng);h.distanceMi=Math.round(L),h.inRadius=typeof y=="number"?L<=y:void 0}}}}catch{}if(T&&typeof N=="number"){const c=w.filter(d=>typeof d.distanceMi!="number"?!0:d.distanceMi<=N);F=c.length===0,w.length=0,w.push(...c)}else if(typeof N=="number"){const c=w.filter(d=>typeof d.distanceMi!="number"||d.distanceMi<=N);c.length>0&&(w.length=0,w.push(...c))}w.__noResultsWithinRadius=F;async function q(c,d){var _,x;const p=c.slice(0,Math.min(d,c.length)),y=[];for(let h=0;h<p.length;h+=10)y.push(p.slice(h,h+10));const S=new Set;for(const h of y){const I=await Promise.all(h.map(async v=>{try{return await ht(v.nctId)}catch{return{studies:[]}}}));for(let v=0;v<h.length;v++){const L=h[v],J=I[v],R=J.studies&&J.studies[0],j=(x=(_=R==null?void 0:R.protocolSection)==null?void 0:_.eligibilityModule)==null?void 0:x.eligibilityCriteria,dt=ct(e.age,R||{},j),ft=At(e.gender,R||{},j),mt=_t(e,R||{},j);(!dt||!ft||!mt.ok)&&S.add(L.nctId)}}return c.filter(h=>!S.has(h.nctId))}const O=await q(w,40);for(const c of O)if(typeof c.distanceMi=="number"){const d=c.distanceMi;let p=0;if(typeof N=="number"&&Number.isFinite(N)){const y=N;d<=y?p=25*(1-d/y):p=-15*Math.min(2,(d-y)/y)}else p=20*(1-Math.min(500,d)/500);c.aiScore=D(Math.round((c.aiScore??0)+p),0,100)}O.sort((c,d)=>{const p=(d.aiScore??0)-(c.aiScore??0);if(p!==0)return p;const y=typeof c.distanceMi=="number"?c.distanceMi:Number.POSITIVE_INFINITY,S=typeof d.distanceMi=="number"?d.distanceMi:Number.POSITIVE_INFINITY;return y-S});try{const{scoreTopKWithAI:c}=await it(async()=>{const{scoreTopKWithAI:p}=await import("./aiScoring-DFmdv_JO.js");return{scoreTopKWithAI:p}},__vite__mapDeps([0,1,2]),import.meta.url);return await c(O,15,e)}catch{return O}}export{kt as a,pt as c,Ot as g,St as r};
