import{f as j,s as L}from"./ctgov-D30T4kGK.js";import{r as R}from"./geocode-Hh4m7xXf.js";const f={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1},k="tc_ai_scores_v4";function y(t,n=0,i=100){return Math.max(n,Math.min(i,t))}function D(t){try{const n=t.trim().replace(/^```\w*\n|```$/g,"").trim();return JSON.parse(n)}catch{return null}}function P(t){let n=5381;for(let i=0;i<t.length;i++)n=n*33^t.charCodeAt(i);return(n>>>0).toString(16)}function J(){try{const t=localStorage.getItem(k);return t?JSON.parse(t):{}}catch{return{}}}function x(t){try{localStorage.setItem(k,JSON.stringify(t))}catch{}}function B(t){const n=JSON.stringify({age:t.age??null,gender:(t.gender||"").toLowerCase(),primaryCondition:(t.primaryCondition||"").toLowerCase(),meds:(t.medications||[]).map(i=>String(i)).sort(),allergies:(t.allergies||[]).map(i=>String(i)).sort(),info:(t.additionalInfo||"").toLowerCase()});return P(n)}function U(t,n){try{const i=JSON.stringify({age:n.age??null,gender:(n.gender||"").toLowerCase(),primaryCondition:(n.primaryCondition||"").toLowerCase(),meds:(n.medications||[]).map(o=>String(o)).sort(),allergies:(n.allergies||[]).map(o=>String(o)).sort(),info:(n.additionalInfo||"").toLowerCase()}),l=`${P(i)}|${t}`,e=J()[l];return e&&Number.isFinite(e.score)?{score:y(Math.round(e.score)),rationale:e.rationale}:null}catch{return null}}function F(t){const n=[];typeof t.age=="number"&&n.push(`Age: ${t.age}`),t.gender&&n.push(`Gender: ${t.gender}`),t.primaryCondition&&n.push(`Primary condition: ${t.primaryCondition}`),t.medications&&t.medications.length&&n.push(`Current medications: ${t.medications.join(", ")}`),t.allergies&&t.allergies.length&&n.push(`Allergies: ${t.allergies.join(", ")}`),t.additionalInfo&&n.push(`Additional info: ${t.additionalInfo}`);const i=R();return i.loc&&n.push(`Home location: ${i.loc}`),i.radius&&n.push(`Travel radius: ${i.radius}`),n.join(`
`)}function V(t){var h,d,m,g,S,w,p,I,b,N,C,O,T,$,E,M,A;const n=((d=(h=t.protocolSection)==null?void 0:h.identificationModule)==null?void 0:d.nctId)||"",i=((g=(m=t.protocolSection)==null?void 0:m.identificationModule)==null?void 0:g.briefTitle)||"",c=((w=(S=t.protocolSection)==null?void 0:S.statusModule)==null?void 0:w.overallStatus)||"",l=((I=(p=t.protocolSection)==null?void 0:p.conditionsModule)==null?void 0:I.conditions)||[],r=((N=(b=t.protocolSection)==null?void 0:b.designModule)==null?void 0:N.phases)||[],e=(T=(O=(C=t.protocolSection)==null?void 0:C.contactsLocationsModule)==null?void 0:O.locations)==null?void 0:T[0],o=[e==null?void 0:e.city,e==null?void 0:e.state,e==null?void 0:e.country].filter(Boolean).join(", "),a=((E=($=t==null?void 0:t.protocolSection)==null?void 0:$.descriptionModule)==null?void 0:E.briefSummary)||"",s=((A=(M=t==null?void 0:t.protocolSection)==null?void 0:M.eligibilityModule)==null?void 0:A.eligibilityCriteria)||"",u=String(s).slice(0,1200);return[`NCT: ${n}`,`Title: ${i}`,`Status: ${c}`,`Conditions: ${l.join("; ")}`,`Phases: ${r.join(", ")}`,`Location: ${o}`,a?`Summary: ${a}`:"",u?`Eligibility Criteria: ${u}`:""].filter(Boolean).join(`
`)}function Y(){const t=f==null?void 0:f.VITE_AI_SCORER_URL,n=f==null?void 0:f.VITE_OPENAI_API_KEY;return typeof window<"u"?!!t:!!(t||n)}async function K(t,n,i){const c="tc_ai_webhook_status_v1";try{const e=localStorage.getItem(c);if(e)try{const o=JSON.parse(e),a=Date.now()-(o.ts||0);if(!o.ok&&a<1e3*60*10)return null}catch{}}catch{}const l=async()=>{try{const e=await L(t,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(n),signal:i});if(!e||!e.ok){try{localStorage.setItem(c,JSON.stringify({ok:!1,ts:Date.now()}))}catch{}return null}const o=await e.json().catch(()=>null);if(!o){try{localStorage.setItem(c,JSON.stringify({ok:!1,ts:Date.now()}))}catch{}return null}try{localStorage.setItem(c,JSON.stringify({ok:!0,ts:Date.now()}))}catch{}const a=typeof o.score=="number"?y(Math.round(o.score)):Number(o.score);return Number.isFinite(a)?{score:y(Math.round(a)),rationale:String(o.rationale||o.reason||"")}:null}catch{try{localStorage.setItem(c,JSON.stringify({ok:!1,ts:Date.now()}))}catch{}return null}},r=await l();return r||(await new Promise(e=>setTimeout(e,500)),l())}async function z(t,n){var c,l,r;if(typeof window<"u")return null;const i=f==null?void 0:f.VITE_OPENAI_API_KEY;if(!i)return null;try{const e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${i}`},body:JSON.stringify({model:"gpt-4o",temperature:.1,messages:[{role:"system",content:"You score clinical trial eligibility and fit. Output ONLY valid compact JSON with fields score (0-100 integer) and rationale (<=160 chars). Do not include any other text."},{role:"user",content:t}],response_format:{type:"json_object"}}),signal:n});if(!e.ok)return null;const o=await e.json(),a=(r=(l=(c=o==null?void 0:o.choices)==null?void 0:c[0])==null?void 0:l.message)==null?void 0:r.content;if(!a)return null;const s=D(a);return!s||!Number.isFinite(s.score)?null:{score:y(Math.round(s.score)),rationale:s.rationale}}catch{return null}}async function W(t,n,i){try{const l=`${B(n)}|${t}`,r=J(),e=r[l];if(e&&Date.now()-e.ts<1e3*60*60*24*7)return{score:e.score,rationale:e.rationale};if(!Y())return null;const o=await j(t,i),a=o&&o.studies&&o.studies[0];if(!a)return null;const s=F(n),u=V(a),h=`Patient Profile
${s}

Trial
${u}

Scoring guidance:
- Base score from inclusion/exclusion likelihood and condition match
- If patient's AGE is outside the trial's eligibility range (as stated in title/criteria), score 0-5 and mention age mismatch
- If gender is restricted and does not match, score 0-10
- If criteria require a planned elective procedure (e.g., hepato-pancreato-biliary or colorectal surgery) and profile lacks that signal, score 0-15 with rationale mentioning missing planned surgery
- Penalize exclusions like daily PDE5 inhibitors or baseline tamsulosin if present in profile meds
- Strongly penalize if outside Travel radius; strongly reward if inside
- Reward status Recruiting; weigh phase modestly
- Return an integer 0-100 with meaningful variance across trials

Strictly output JSON: {"score": 0-100 integer, "rationale": "<=160 chars"}.`,d=new AbortController,m=setTimeout(()=>d.abort(),2e4);let g=null;const p=(f==null?void 0:f.VITE_AI_SCORER_URL)||"/.netlify/functions/ai-scorer";return g=await K(p,{profile:n,nctId:t,study:a,prompt:h},d.signal),g||(g=await z(h,d.signal)),g?(clearTimeout(m),g&&(r[l]={score:g.score,rationale:g.rationale,ts:Date.now()},x(r)),g):(clearTimeout(m),null)}catch{return null}}async function H(t,n,i){const c=t.slice(0,Math.min(n,t.length));for(const r of c){const e=U(r.nctId,i);e&&(r.aiScore=y(Math.round(e.score)),e.rationale&&(r.aiRationale=e.rationale))}(async()=>{try{const r=[...c],e=new Array(r.length);async function o(s){for(let u=s;u<r.length;u+=3){const h=r[u];try{const d=await W(h.nctId,i);d&&(e[u]={idx:u,score:d.score,rationale:d.rationale})}catch{}}}await Promise.all([o(0),o(1),o(2)]);let a=!1;for(let s=0;s<e.length;s++){const u=e[s];u&&typeof u.score=="number"&&(a=!0)}if(a)try{window.dispatchEvent(new Event("storage"))}catch{}}catch{}})();const l=t.map(r=>({...r}));return l.sort((r,e)=>{const o=(e.aiScore??0)-(r.aiScore??0);if(o!==0)return o;const a=typeof r.distanceMi=="number"?r.distanceMi:Number.POSITIVE_INFINITY,s=typeof e.distanceMi=="number"?e.distanceMi:Number.POSITIVE_INFINITY;return a-s}),l}export{U as getCachedAiScore,W as scoreStudyWithAI,H as scoreTopKWithAI};
